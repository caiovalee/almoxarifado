<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Almoxarifado Pessoal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100">
  <div id="root"></div>

  <!-- React + ReactDOM UMD -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <!-- Babel para compilar JSX no navegador -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="react">
    const { useEffect, useMemo, useState } = React;

    // =============================
    // Utilidades
    // =============================
    function uid() { return `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`; }
    function classNames(...xs) { return xs.filter(Boolean).join(" "); }
    function parseDate(d){ if(!d) return null; const [y,m,day]=d.split("-").map(n=>parseInt(n,10)); if(!y||!m||!day) return null; return new Date(y,m-1,day); }
    function daysUntil(dateISO){ const d=parseDate(dateISO); if(!d) return null; const now=new Date(); const ms=d.setHours(23,59,59,999)-now.getTime(); return Math.ceil(ms/86400000); }
    function validadeStatus(it){ if(!it.validade) return {label:"—", tone:"muted"}; const dias=daysUntil(it.validade); if(dias==null) return {label:it.validade, tone:"muted"}; if(dias<0) return {label:`Vencido há ${Math.abs(dias)}d`, tone:"danger"}; if(dias===0) return {label:"Vence hoje", tone:"warning"}; if(dias<=30) return {label:`Vence em ${dias}d`, tone:"warning"}; return {label:it.validade, tone:"ok"}; }
    function lowStock(it){ return it.quantidade < (isFinite(it.min)? it.min : 0); }

    const CATEGORIAS_PADRAO = ["Remédios","Cuidados Pessoais","Papelaria","Diversos"];

    // ===== UI primitives =====
    const Pill = ({ children, tone = "muted" }) => (
      <span className={classNames("inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium",
        tone==="danger"&&"bg-red-100 text-red-800",
        tone==="warning"&&"bg-amber-100 text-amber-800",
        tone==="ok"&&"bg-emerald-100 text-emerald-800",
        tone==="muted"&&"bg-slate-100 text-slate-700")}>{children}</span>
    );

    const Section = ({ title, children, right }) => (
      <section className="bg-white rounded-2xl shadow p-4">
        <div className="flex items-center justify-between mb-3">
          <h2 className="text-lg font-semibold text-slate-900">{title}</h2>
          {right}
        </div>
        {children}
      </section>
    );

    const Icon = {
      Plus:(p)=>(<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className="w-5 h-5" {...p}><path strokeWidth="2" strokeLinecap="round" d="M12 5v14M5 12h14"/></svg>),
      Trash:(p)=>(<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className="w-5 h-5" {...p}><path strokeWidth="2" strokeLinecap="round" d="M3 6h18M8 6V4h8v2M6 6l1 14h10l1-14"/></svg>),
      Edit:(p)=>(<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className="w-5 h-5" {...p}><path strokeWidth="2" strokeLinecap="round" d="M4 20l4-1 9-9a2.5 2.5 0 10-3.5-3.5L4.5 15.5 4 20z"/></svg>),
      Search:(p)=>(<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className="w-4 h-4" {...p}><circle cx="11" cy="11" r="7" strokeWidth="2"/><path strokeWidth="2" strokeLinecap="round" d="M20 20l-3-3"/></svg>),
      Filter:(p)=>(<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className="w-5 h-5" {...p}><path strokeWidth="2" strokeLinecap="round" d="M4 6h16M7 12h10M10 18h4"/></svg>),
      Cart:(p)=>(<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className="w-5 h-5" {...p}><path strokeWidth="2" strokeLinecap="round" d="M3 4h2l2 12h10l2-8H7"/><circle cx="10" cy="20" r="1"/><circle cx="17" cy="20" r="1"/></svg>),
      Minus:(p)=>(<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className="w-4 h-4" {...p}><path strokeWidth="2" strokeLinecap="round" d="M5 12h14"/></svg>)
    };

    // ===== Header (sem perfis e sem imprimir) =====
    function Header({ onAdd, onShowCompras, comprasCount }){
      return (
        <header className="sticky top-0 z-20 backdrop-blur bg-white/70 border-b border-slate-200">
          <div className="max-w-7xl mx-auto px-4 py-3 flex flex-wrap gap-2 items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-9 h-9 rounded-2xl bg-indigo-600 text-white grid place-items-center font-bold shadow">AP</div>
              <div>
                <h1 className="text-xl font-bold text-slate-900">Almoxarifado Pessoal</h1>
                <p className="text-xs text-slate-500">Inventário pessoal simples</p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <button onClick={onShowCompras} className="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white inline-flex items-center gap-2"><Icon.Cart/> Lista de compras {comprasCount>0 && <span className="ml-1 text-emerald-200">({comprasCount})</span>}</button>
              <button onClick={onAdd} className="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white inline-flex items-center gap-2"><Icon.Plus/> Novo item</button>
            </div>
          </div>
        </header>
      );
    }

    function Toolbar({ categoria, setCategoria, sortBy, setSortBy, categorias, onManageCats }){
      return (
        <div className="flex flex-col md:flex-row gap-3 items-center justify-between">
          <div className="flex gap-2 items-center flex-wrap">
            <div className="flex gap-1 bg-slate-100 p-1 rounded-xl">
              {["Todas", ...categorias].map((c) => (
                <button key={c} onClick={()=>setCategoria(c)} className={classNames("px-3 py-1.5 text-sm rounded-lg", categoria===c?"bg-white shadow text-slate-900":"text-slate-600 hover:text-slate-900")}>{c}</button>
              ))}
            </div>
            <button onClick={onManageCats} className="px-3 py-2 rounded-xl border border-slate-300 text-slate-700 hover:bg-slate-50">Gerenciar categorias</button>
          </div>
          <div className="flex items-center gap-2">
            <Icon.Filter className="text-slate-400"/>
            <select value={sortBy} onChange={(e)=>setSortBy(e.target.value)} className="px-3 py-2 rounded-xl border border-slate-300 bg-white text-slate-900">
              <option value="updated">Ordenar: Atualização recente</option>
              <option value="nome">Ordenar: Nome (A→Z)</option>
              <option value="quantidade">Ordenar: Quantidade (↓)</option>
              <option value="validade">Ordenar: Validade (mais cedo)</option>
              <option value="categoria">Ordenar: Categoria</option>
            </select>
          </div>
        </div>
      );
    }

    function Stats({ items }){
      const total=items.length; const baixos=items.filter(lowStock).length; const vencendo=items.filter(it=>{ const s=validadeStatus(it); return s.tone==="warning"||s.tone==="danger"; }).length; const byCat=new Map(); for(const it of items){ byCat.set(it.categoria,(byCat.get(it.categoria)||0)+1); }
      return (
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div className="bg-indigo-50 rounded-2xl p-4"><div className="text-sm text-indigo-700">Total de itens</div><div className="text-2xl font-bold text-indigo-900">{total}</div></div>
          <div className="bg-emerald-50 rounded-2xl p-4"><div className="text-sm text-emerald-700">Categorias</div><div className="text-2xl font-bold text-emerald-900">{Array.from(byCat.keys()).length} <span className="text-sm font-normal">ativas</span></div></div>
          <div className="bg-amber-50 rounded-2xl p-4"><div className="text-sm text-amber-700">Vencendo/Expirados</div><div className="text-2xl font-bold text-amber-900">{vencendo}</div></div>
          <div className="bg-rose-50 rounded-2xl p-4"><div className="text-sm text-rose-700">Baixo estoque</div><div className="text-2xl font-bold text-rose-900">{baixos}</div></div>
        </div>
      );
    }

    function Table({ items, onInc, onDec, onEdit, onDelete }){
      return (
        <div className="overflow-x-auto">
          <table className="min-w-full border-separate border-spacing-y-2">
            <thead>
              <tr className="text-left text-xs uppercase text-slate-500">
                <th className="px-3">Item</th><th className="px-3">Qtd</th><th className="px-3">Mín</th><th className="px-3">Validade</th><th className="px-3">Local</th><th className="px-3">Ações</th>
              </tr>
            </thead>
            <tbody>
              {items.map((it)=>{ const v=validadeStatus(it); const isLow=lowStock(it); return (
                <tr key={it.id} className="bg-white shadow rounded-xl">
                  <td className="px-3 py-3 align-top"><div className="font-medium text-slate-900">{it.nome}</div><div className="flex flex-wrap gap-1 mt-1 items-center"><Pill tone="muted">{it.categoria}</Pill>{it.notas && <span className="text-xs text-slate-500">• {it.notas}</span>}</div></td>
                  <td className="px-3 py-3 align-top"><div className={classNames("inline-flex items-center gap-2 px-2 py-1 rounded-xl border", isLow?"border-rose-300 bg-rose-50 text-rose-700":"border-slate-300")}>
                    <button type="button" onClick={()=>onDec(it)} className="p-1 rounded hover:bg-slate-100"><Icon.Minus/></button>
                    <span className="tabular-nums font-semibold">{it.quantidade} {it.unidade||"un"}</span>
                    <button type="button" onClick={()=>onInc(it)} className="p-1 rounded hover:bg-slate-100"><Icon.Plus/></button>
                  </div></td>
                  <td className="px-3 py-3 align-top"><span className="tabular-nums text-slate-700">{isFinite(it.min)?it.min:0}</span></td>
                  <td className="px-3 py-3 align-top"><Pill tone={v.tone}>{v.label}</Pill></td>
                  <td className="px-3 py-3 align-top"><span className="text-slate-700">{it.local||"—"}</span></td>
                  <td className="px-3 py-3 align-top"><div className="flex gap-2"><button type="button" onClick={()=>onEdit(it)} className="px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50 inline-flex items-center gap-1"><Icon.Edit/> Editar</button><button type="button" onClick={()=>onDelete(it)} className="px-2 py-1 rounded-lg bg-rose-600 hover:bg-rose-700 text-white inline-flex items-center gap-1"><Icon.Trash/> Remover</button></div></td>
                </tr> ); })}
            </tbody>
          </table>
        </div>
      );
    }

    function Modal({ open, onClose, title, children, footer }){ if(!open) return null; return (
      <div className="fixed inset-0 z-30">
        <div className="absolute inset-0 bg-slate-900/50" onClick={onClose} />
        <div className="absolute inset-0 flex items-center justify-center p-4">
          <div className="w-full max-w-2xl bg-white rounded-2xl shadow-xl border border-slate-200">
            <div className="p-4 border-b border-slate-200 flex items-center justify-between"><h3 className="text-lg font-semibold text-slate-900">{title}</h3><button onClick={onClose} className="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-50">Fechar</button></div>
            <div className="p-4 max-h-[70vh] overflow-auto">{children}</div>
            {footer && <div className="p-4 border-t border-slate-200 bg-slate-50 rounded-b-2xl">{footer}</div>}
          </div>
        </div>
      </div> ); }

    function ManageCategoriesModal({ open, onClose, categorias, setCategorias, items, setItems }){
      const [novo, setNovo] = useState("");
      const counts = useMemo(()=>{ const m=new Map(); for(const c of categorias) m.set(c,0); for(const it of items) m.set(it.categoria,(m.get(it.categoria)||0)+1); return m; },[categorias,items]);
      function addCategoria(){ const name=(novo||"").trim(); if(!name) return; setCategorias(prev=> prev.includes(name)? prev : [...prev, name]); setNovo(""); }
      function renomear(oldName){ const novoNome=prompt(`Renomear "${oldName}" para:`, oldName); if(!novoNome||novoNome.trim()===oldName) return; const newN=novoNome.trim(); setCategorias(prev=> Array.from(new Set(prev.map(c=> c===oldName? newN: c)))); setItems(prev=> prev.map(it=> it.categoria===oldName? {...it, categoria:newN, updatedAt:Date.now()}: it)); alert("Categoria renomeada."); }
      function remover(name){ const usados=counts.get(name)||0; if(usados>0){ if(!confirm(`A categoria "${name}" possui ${usados} item(ns). Remover e mover para "Diversos"?`)) return; setItems(prev=> prev.map(it=> it.categoria===name? {...it, categoria:"Diversos", updatedAt:Date.now()}: it)); } setCategorias(prev=> prev.filter(c=> c!==name)); }
      if(!open) return null; return (
        <Modal open={open} onClose={onClose} title="Gerenciar categorias">
          <div className="space-y-3">
            <div className="flex gap-2"><input value={novo} onChange={(e)=>setNovo(e.target.value)} placeholder="Nova categoria" className="flex-1 px-3 py-2 rounded-xl border border-slate-300 bg-white"/><button onClick={addCategoria} className="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white">Adicionar</button></div>
            <ul className="divide-y divide-slate-200">{categorias.map(c=> (
              <li key={c} className="py-2 flex items-center justify-between"><div className="flex items-center gap-2"><Pill tone="muted">{c}</Pill><span className="text-xs text-slate-500">{counts.get(c)||0} itens</span></div><div className="flex gap-2"><button onClick={()=>renomear(c)} className="px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50 inline-flex items-center gap-1"><Icon.Edit/> Renomear</button><button onClick={()=>remover(c)} className="px-2 py-1 rounded-lg bg-rose-600 hover:bg-rose-700 text-white inline-flex items-center gap-1"><Icon.Trash/> Remover</button></div></li>
            ))}</ul>
            <p className="text-xs text-slate-500">Ao remover uma categoria com itens, eles serão movidos para "Diversos".</p>
          </div>
        </Modal> ); }

    function ItemForm({ initial, onSubmit, onCancel, categorias, onCreateCategoria }){
      const [form, setForm] = useState(()=> initial || ({ id:uid(), nome:"", categoria:"Remédios", quantidade:1, unidade:"un", min:0, validade:"", local:"", notas:"", createdAt:Date.now(), updatedAt:Date.now() }));
      useEffect(()=>{ if(initial) setForm(initial); },[initial]);
      function setField(k,v){ setForm(f=>({...f, [k]:v, updatedAt:Date.now()})); }
      function handleSubmit(e){ e.preventDefault(); if(!form.nome.trim()) return alert("Informe o nome do item."); if(!form.categoria) return alert("Selecione a categoria."); onSubmit({...form, validade: form.validade||""}); }
      return (
        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div className="md:col-span-2"><label className="text-sm text-slate-600">Nome</label><input value={form.nome} onChange={(e)=>setField("nome", e.target.value)} className="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white" placeholder="Ex.: Dipirona 500mg, Desodorante Nivea, Caneta esferográfica"/></div>
          <div><label className="text-sm text-slate-600">Categoria</label>
            <select value={form.categoria} onChange={(e)=>{ const v=e.target.value; if(v==="__new__"){ const nome=prompt("Nome da nova categoria:"); if(nome&&nome.trim()){ const novo=nome.trim(); onCreateCategoria?.(novo); setField("categoria", novo);} } else { setField("categoria", v); } }} className="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white">
              <option value="__new__">+ Criar nova categoria…</option>
              {categorias.map(c=>(<option key={c} value={c}>{c}</option>))}
            </select>
          </div>
          <div><label className="text-sm text-slate-600">Quantidade</label><input type="number" inputMode="numeric" value={form.quantidade} onChange={(e)=>setField("quantidade", Number(e.target.value))} className="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white"/></div>
          <div><label className="text-sm text-slate-600">Unidade</label><input value={form.unidade} onChange={(e)=>setField("unidade", e.target.value)} className="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white" placeholder="un, ml, g, L..."/></div>
          <div><label className="text-sm text-slate-600">Estoque mínimo</label><input type="number" inputMode="numeric" value={form.min} onChange={(e)=>setField("min", Number(e.target.value))} className="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white"/></div>
          <div><label className="text-sm text-slate-600">Validade (se houver)</label><input type="date" value={form.validade||""} onChange={(e)=>setField("validade", e.target.value)} className="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white"/></div>
          <div><label className="text-sm text-slate-600">Local (ex.: armário, gaveta)</label><input value={form.local} onChange={(e)=>setField("local", e.target.value)} className="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white"/></div>
          <div className="md:col-span-2"><label className="text-sm text-slate-600">Notas</label><textarea value={form.notas} onChange={(e)=>setField("notas", e.target.value)} rows={3} className="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white" placeholder="Observações, fabricante, lote, restrições, etc."/></div>
          <div className="md:col-span-2 flex items-center justify-end gap-2"><button type="button" onClick={onCancel} className="px-4 py-2 rounded-xl border border-slate-300 hover:bg-slate-50">Cancelar</button><button type="submit" className="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white">Salvar</button></div>
        </form>
      );
    }

    function ComprasView({ items }){
      const lista = items.filter(it=> lowStock(it) || validadeStatus(it).tone==="danger");
      const texto = lista.map(it=> `- ${it.nome} (${it.categoria}) — estoque: ${it.quantidade} ${it.unidade||"un"} | mín: ${isFinite(it.min)?it.min:0}${it.validade?` | validade: ${it.validade}`:""}`).join("\n");
      function copiar(){ navigator.clipboard?.writeText(texto).then(()=>alert("Lista copiada.")) .catch(()=>{ prompt("Copie a lista:", texto); }); }
      return (
        <div>
          <p className="text-sm text-slate-600 mb-3">Itens com estoque abaixo do mínimo ou vencidos:</p>
          <ul className="space-y-2">
            {lista.length===0 && <li className="text-slate-500">Tudo em dia! 🎉</li>}
            {lista.map(it=>{ const v=validadeStatus(it); return (
              <li key={it.id} className="p-3 rounded-xl border border-slate-200 flex items-center justify-between">
                <div>
                  <div className="font-medium">{it.nome} <span className="text-xs text-slate-500">({it.categoria})</span></div>
                  <div className="text-sm text-slate-600">Estoque: {it.quantidade} {it.unidade||"un"} • Mín: {isFinite(it.min)?it.min:0} • Validade: <Pill tone={v.tone}>{v.label}</Pill></div>
                </div>
                <div><Pill tone={lowStock(it)?"danger":"warning"}>{lowStock(it)?"Repor":"Atenção"}</Pill></div>
              </li> ); })}
          </ul>
          {lista.length>0 && <div className="mt-4 flex gap-2"><button onClick={copiar} className="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white">Copiar lista</button></div>}
          <pre className="mt-4 p-3 bg-slate-50 rounded-xl text-sm overflow-auto whitespace-pre-wrap">{texto||""}</pre>
        </div>
      );
    }

    // ===== Persistência simples (sem perfis) =====
    const LS_ITEMS = "almoxarifado-items-v2";
    const LS_CATS  = "almoxarifado-categorias-v2";
    // chaves antigas p/ migração opcional
    const OLD_ITEMS = "almoxarifado-items-v1";
    const OLD_CATS  = "almoxarifado-categorias-v1";
    const LS_ACTIVE = "almoxarifado-active-profile-v1";
    const LS_DATA_PREFIX = "almoxarifado-data-v1::";

    function loadInitial(){
      // 1) se já existem as chaves v2, usa elas
      try{
        const i = JSON.parse(localStorage.getItem(LS_ITEMS)||"null");
        const c = JSON.parse(localStorage.getItem(LS_CATS)||"null");
        if(Array.isArray(i) && Array.isArray(c)) return { items:i, cats:c.length?c:CATEGORIAS_PADRAO };
      }catch{}
      // 2) migrar de v1 (sem perfis)
      try{
        const i = JSON.parse(localStorage.getItem(OLD_ITEMS)||"null");
        const c = JSON.parse(localStorage.getItem(OLD_CATS)||"null");
        if(Array.isArray(i) || Array.isArray(c)){
          const data={ items:i||[], cats:(c&&c.length?c:CATEGORIAS_PADRAO) };
          localStorage.setItem(LS_ITEMS, JSON.stringify(data.items));
          localStorage.setItem(LS_CATS, JSON.stringify(data.cats));
          return data;
        }
      }catch{}
      // 3) tentar migrar do perfil ativo (não protegido)
      try{
        const active = localStorage.getItem(LS_ACTIVE) || "voce";
        const raw = localStorage.getItem(LS_DATA_PREFIX+active);
        if(raw){ const obj=JSON.parse(raw); if(obj && !obj.__enc){
          const data={ items:obj.items||[], cats:obj.cats||CATEGORIAS_PADRAO };
          localStorage.setItem(LS_ITEMS, JSON.stringify(data.items));
          localStorage.setItem(LS_CATS, JSON.stringify(data.cats));
          return data;
        } }
      }catch{}
      // 4) vazio
      return { items:[], cats:CATEGORIAS_PADRAO };
    }

    function AlmoxarifadoApp(){
      const [data, setData] = useState(loadInitial);

      // salvar sempre que mudar
      useEffect(()=>{
        try{ localStorage.setItem(LS_ITEMS, JSON.stringify(data.items)); }catch{}
        try{ localStorage.setItem(LS_CATS, JSON.stringify(data.cats)); }catch{}
      },[data]);

      // exemplos iniciais (se vazio)
      useEffect(()=>{
        if((data.items||[]).length===0){
          const nextDays=(delta)=>{ const d=new Date(); d.setDate(d.getDate()+delta); return d.toISOString().slice(0,10); };
          const ex = [
            { id: uid(), nome: "Dipirona 500mg", categoria: "Remédios", quantidade: 8, unidade: "cp", min: 6, validade: nextDays(45), local: "Armário do banheiro", notas: "Analgésico", createdAt: Date.now()-1000000, updatedAt: Date.now()-1000000 },
            { id: uid(), nome: "Paracetamol 750mg", categoria: "Remédios", quantidade: 2, unidade: "cp", min: 6, validade: nextDays(-5), local: "Armário do banheiro", notas: "Ver lote", createdAt: Date.now()-1000000, updatedAt: Date.now()-1000000 },
            { id: uid(), nome: "Desodorante", categoria: "Cuidados Pessoais", quantidade: 1, unidade: "un", min: 1, validade: "", local: "Gaveta direita", notas: "Rexona", createdAt: Date.now()-900000, updatedAt: Date.now()-900000 },
            { id: uid(), nome: "Algodão", categoria: "Papelaria", quantidade: 0, unidade: "pct", min: 1, validade: "", local: "Caixa 2", notas: "Bolinhas", createdAt: Date.now()-800000, updatedAt: Date.now()-800000 },
            { id: uid(), nome: "Caneta esferográfica", categoria: "Papelaria", quantidade: 3, unidade: "un", min: 5, validade: "", local: "Prateleira", notas: "Azul", createdAt: Date.now()-700000, updatedAt: Date.now()-700000 },
            { id: uid(), nome: "Pilhas AA", categoria: "Diversos", quantidade: 10, unidade: "un", min: 4, validade: nextDays(365), local: "Gaveta eletrônicos", notas: "Alcalina", createdAt: Date.now()-600000, updatedAt: Date.now()-600000 }
          ];
          setData(d=> ({...d, items: ex}));
        }
        try { if (typeof window !== 'undefined' && !window.__almox_tests) { runSelfTests(); window.__almox_tests = true; } } catch {}
      }, []);

      // CRUD itens
      const [showForm, setShowForm] = useState(false);
      const [editing, setEditing] = useState(null);
      const [showCompras, setShowCompras] = useState(false);
      const [showCats, setShowCats] = useState(false);

      function addItem(){ setEditing(null); setShowForm(true); }
      function saveItem(it){ setData(d=>{ const exists=d.items.some(p=>p.id===it.id); const items= exists? d.items.map(p=> p.id===it.id? {...it, updatedAt:Date.now()}: p): [{...it, createdAt:Date.now(), updatedAt:Date.now()}, ...d.items]; return {...d, items}; }); setShowForm(false); }
      function editItem(it){ setEditing(it); setShowForm(true); }
      function deleteItem(it){ setData(d=> ({...d, items: d.items.filter(p=>p.id!==it.id)})); }
      function inc(it){ setData(d=> ({...d, items: d.items.map(p=> p.id===it.id? {...p, quantidade:(p.quantidade||0)+1, updatedAt:Date.now()}: p)})); }
      function dec(it){ setData(d=> ({...d, items: d.items.map(p=> p.id===it.id? {...p, quantidade: Math.max(0,(p.quantidade||0)-1), updatedAt:Date.now()}: p)})); }

      function setCats(fnOrArr){ setData(d=> ({...d, cats: typeof fnOrArr==='function'? fnOrArr(d.cats): fnOrArr })); }

      // busca/ordenação/filtros
      const [query, setQuery] = useState("");
      const [categoria, setCategoria] = useState("Todas");
      const [sortBy, setSortBy] = useState("updated");

      const displayCats = useMemo(()=>{ const set=new Set([...(data.cats||[])]); for(const it of data.items) if(it.categoria) set.add(it.categoria); return Array.from(set); },[data]);
      useEffect(()=>{ if(categoria!=="Todas" && !displayCats.includes(categoria)) setCategoria("Todas"); },[displayCats]);

      const filtered = useMemo(()=>{ let out=[...data.items]; if(categoria!=="Todas") out=out.filter(it=> it.categoria===categoria); if(query.trim()){ const q=query.toLowerCase(); out=out.filter(it=> it.nome.toLowerCase().includes(q) || (it.local||"").toLowerCase().includes(q) || (it.notas||"").toLowerCase().includes(q)); } switch(sortBy){ case "nome": out.sort((a,b)=> a.nome.localeCompare(b.nome,"pt-BR")); break; case "categoria": out.sort((a,b)=> a.categoria.localeCompare(b.categoria,"pt-BR")||a.nome.localeCompare(b.nome,"pt-BR")); break; case "quantidade": out.sort((a,b)=> b.quantidade-a.quantidade); break; case "validade": out.sort((a,b)=> (parseDate(a.validade)?.getTime()||Infinity)-(parseDate(b.validade)?.getTime()||Infinity)); break; default: out.sort((a,b)=> b.updatedAt-a.updatedAt); } return out; },[data.items, categoria, query, sortBy]);

      const comprasCount = useMemo(()=> data.items.filter(it=> lowStock(it) || validadeStatus(it).tone==="danger").length, [data.items]);

      return (
        <div className="min-h-screen bg-slate-100">
          <Header onAdd={addItem} onShowCompras={()=>setShowCompras(true)} comprasCount={comprasCount} />

          <main className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <Section title="Resumo"><Stats items={data.items} /></Section>

            <Section title={<span className="inline-flex items-center gap-2"><Icon.Search className="w-5 h-5"/> Inventário</span>} right={<div className="flex items-center gap-3"><div className="relative w-72"><Icon.Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"/><input value={query} onChange={(e)=>setQuery(e.target.value)} placeholder="Buscar por nome, local ou notas..." className="w-full pl-10 pr-3 py-2 rounded-xl border border-slate-300 bg-white text-slate-900 placeholder-slate-400"/></div><span className="text-xs text-slate-500">{filtered.length} itens</span></div>}>
              <div className="space-y-4">
                <Toolbar categoria={categoria} setCategoria={setCategoria} sortBy={sortBy} setSortBy={setSortBy} categorias={displayCats} onManageCats={()=>setShowCats(true)} />
                <Table items={filtered} onInc={inc} onDec={dec} onEdit={editItem} onDelete={deleteItem} />
              </div>
            </Section>
          </main>

          {/* Modais */}
          <Modal open={showForm} onClose={()=>setShowForm(false)} title={editing?"Editar item":"Novo item"}>
            <ItemForm initial={editing} onSubmit={saveItem} onCancel={()=>setShowForm(false)} categorias={displayCats} onCreateCategoria={(nome)=> setCats(prev=> prev.includes(nome)? prev : [...prev, nome])} />
          </Modal>

          <ManageCategoriesModal open={showCats} onClose={()=>setShowCats(false)} categorias={data.cats} setCategorias={(cats)=> setCats(cats)} items={data.items} setItems={(items)=> setData(d=> ({...d, items}))} />

          <Modal open={showCompras} onClose={()=>setShowCompras(false)} title="Lista de compras"><ComprasView items={data.items} /></Modal>

          <footer className="max-w-7xl mx-auto px-4 pb-10 pt-2 text-center text-xs text-slate-500">Feito com ♥ para organizar seu estoque. Dica: use o campo "mín" para gerar automaticamente a lista de compras quando faltar algo.</footer>

          <style>{`
            @media print { header, footer, .no-print { display: none !important; } main { padding: 0 !important; } body { background: white !important; } }
          `}</style>
        </div>
      );
    }

    // =============================
    // Auto-testes (console)
    // =============================
    function runSelfTests(){
      console.groupCollapsed("Almoxarifado – auto-testes");
      const today=(()=>{ const d=new Date(); const tz=d.getTimezoneOffset(); const local=new Date(d.getTime()-tz*60000); return local.toISOString().slice(0,10); })();
      console.assert(parseDate("2025-10-01") instanceof Date, "parseDate deve retornar Date válido");
      console.assert(parseDate("")===null, "parseDate vazio deve retornar null");
      console.assert(daysUntil(today)>=-1, "daysUntil não deve falhar na data de hoje");
      const itm1={ validade:"", quantidade:1, min:0 }; console.assert(validadeStatus(itm1).tone==="muted", "Sem validade => muted");
      const tomorrow=(()=>{ const d=new Date(); d.setDate(d.getDate()+1); return d.toISOString().slice(0,10); })(); const itm2={ validade:tomorrow, quantidade:1, min:0 }; console.assert(["ok","warning"].includes(validadeStatus(itm2).tone), "Validade futura => ok/warning");
      const past=(()=>{ const d=new Date(); d.setDate(d.getDate()-2); return d.toISOString().slice(0,10); })(); const itm3={ validade:past, quantidade:1, min:0 }; console.assert(validadeStatus(itm3).tone==="danger", "Validade passada => danger");
      console.assert(lowStock({ quantidade:0, min:1 })===true, "0<1 => baixo estoque");
      console.assert(lowStock({ quantidade:1, min:1 })===false, "igual ao mínimo => estoque ok");
      console.assert(lowStock({ quantidade:2, min:3 })===true, "2<3 => baixo estoque");
      console.assert(lowStock({ quantidade:3, min:2 })===false, "3>2 => ok");
      const id1=uid(), id2=uid(); console.assert(id1!==id2, "uid deve gerar valores diferentes");
      console.assert(classNames('a', null, undefined, 'b')==='a b', "classNames deve ignorar falsy");
      console.groupEnd();
    }

    // monta app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AlmoxarifadoApp />);
  </script>
</body>
</html>
